"use strict";
/*---------------------------------------------------------
 * Copyright (C) Microsoft Corporation. All rights reserved.
 *--------------------------------------------------------*/
var stringjs = require("string");
var VsOptinStatusReader = (function () {
    function VsOptinStatusReader(registryTools) {
        this._registryTools = registryTools;
    }
    /**
     * Read IsOptedIn status for current product.
     * <param name="productVersion">VS product version is needed to build a config path</param>
     */
    VsOptinStatusReader.prototype.readIsOptedInStatus = function (productVersion) {
        var _this = this;
        if (process.platform !== "win32") {
            return Promise.reject(new Error("this method isn't supported for non-Windows OS"));
        }
        return this._registryTools.getNumberFromHKLM(VsOptinStatusReader.globalPolicyOptedInRegistryPath, VsOptinStatusReader.optedInRegistryKeyName)
            .then(function (globalPolicyValue) {
            return globalPolicyValue === VsOptinStatusReader.userIsOptedInValue;
        })
            .catch(function (_) {
            // can't read global policies, try to read local one
            return _this._registryTools.getNumberFromHKLM(stringjs(VsOptinStatusReader.localOptedInRegistryPath).replaceAll("{0}", productVersion).s, VsOptinStatusReader.optedInRegistryKeyName)
                .then(function (localValue) {
                return localValue === VsOptinStatusReader.userIsOptedInValue;
            })
                .catch(function () { return false; });
        });
    };
    VsOptinStatusReader.globalPolicyOptedInRegistryPath = "\\Software\\Policies\\Microsoft\\VisualStudio\\SQM";
    VsOptinStatusReader.localOptedInRegistryPath = "\\Software\\Microsoft\\VSCommon\\{0}\\SQM";
    VsOptinStatusReader.optedInRegistryKeyName = "OptIn";
    VsOptinStatusReader.userIsOptedInValue = 1;
    return VsOptinStatusReader;
}());
exports.VsOptinStatusReader = VsOptinStatusReader;
